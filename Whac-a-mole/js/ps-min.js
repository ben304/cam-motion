function fastAbs(e){return e^(e>>31)-(e>>31)}function threshold(e){return e>32?255:0}Filters={};var SENS=20;Filters.getPixels=function(e){var t=this.getCanvas(e.width,e.height),n=t.getContext("2d");n.drawImage(e);return n.getImageData(0,0,t.width,t.height)};Filters.getCanvas=function(e,t){var n=document.createElement("canvas");n.width=e;n.height=t;return n};Filters.filterImage=function(e,t,n){var r=[this.getPixels(t)];for(var i=2;i<arguments.length;i++)r.push(arguments[i]);return e.apply(null,r)};Filters.grayscale=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){var i=n[r],s=n[r+1],o=n[r+2],u=.2126*i+.7152*s+.0722*o;n[r]=n[r+1]=n[r+2]=u}return e};Filters.brightness=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){n[r]+=t;n[r+1]+=t;n[r+2]+=t}return e};Filters.threshold=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){var i=n[r],s=n[r+1],o=n[r+2],u=.2126*i+.7152*s+.0722*o>=t?255:0;n[r]=n[r+1]=n[r+2]=u}return e};Filters.filter=function(e,t){var n=e.data;for(var r=0;r<n.length;r+=4){var i=n[r],s=n[r+1],o=n[r+2],u=i>=t[0]-SENS&&i<=t[0]+SENS&&s>=t[1]-SENS&&s<=t[1]+SENS&&o>=t[2]-SENS&&o<=t[2]+SENS?0:255;n[r]=n[r+1]=n[r+2]=u}return e};Filters.tmpCanvas=document.createElement("canvas");Filters.tmpCtx=Filters.tmpCanvas.getContext("2d");Filters.createImageData=function(e,t){return this.tmpCtx.createImageData(e,t)};Filters.convolute=function(e,t,n){var r=Math.round(Math.sqrt(t.length)),i=Math.floor(r/2),s=e.data,o=e.width,u=e.height,a=o,f=u,l=Filters.createImageData(a,f),c=l.data,h=n?1:0;for(var p=0;p<f;p++)for(var d=0;d<a;d++){var v=p,m=d,g=(p*a+d)*4,y=0,b=0,w=0,E=0;for(var S=0;S<r;S++)for(var x=0;x<r;x++){var T=v+S-i,N=m+x-i;if(T>=0&&T<u&&N>=0&&N<o){var C=(T*o+N)*4,k=t[S*r+x];y+=s[C]*k;b+=s[C+1]*k;w+=s[C+2]*k;E+=s[C+3]*k}}c[g]=y;c[g+1]=b;c[g+2]=w;c[g+3]=E+h*(255-E)}return l};Filters.differenceAccuracy=function(e,t,n){if(t.length!=n.length)return null;var r=0;while(r<t.length*.25){var i=(t[4*r]+t[4*r+1]+t[4*r+2])/3,s=(n[4*r]+n[4*r+1]+n[4*r+2])/3,o=threshold(fastAbs(i-s));e[4*r]=o;e[4*r+1]=o;e[4*r+2]=o;e[4*r+3]=255;++r}};Filters.difference=function(e,t){var n=e.data,r=t.data,i=n,s=1/255;for(var o=0;o<n.length;o+=4){i[o]=Math.abs(n[o]-r[o]);i[o+1]=Math.abs(n[o+1]-r[o+1]);i[o+2]=Math.abs(n[o+2]-r[o+2]);i[o+3]=0}return e};